app:
  description: Automated workflow for fetching RSS items, rewriting content, and publishing to WordPress.
  icon: ðŸ¤–
  icon_background: "#FFEAD5"
  mode: workflow
  name: Local News Automation

workflow:
  version: 0.1.2
  features:
    file_upload:
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
          - local_file
          - remote_url
    opening_statement: ""
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    text_to_speech:
      enabled: false
      language: ""
      voice: ""
  
  graph:
    nodes:
      - id: start
        data:
          title: Start
          type: start
          variables:
            - label: Item ID
              variable: item_id
              type: text
              required: true
              max_length: 48
              options: []
            - label: Supabase URL
              variable: supabase_url
              type: text
              required: true
              default: "https://ugpmpinhkdndajjflnfz.supabase.co"
            - label: Supabase Key
              variable: supabase_key
              type: text
              required: true
              default: "sb_publishable_sOvTFpHdhiVwgW1SL14TDA_tRcQ7pTx"
          desc: "Entry point triggered by API or scheduler."
          selected: false
        position:
          x: 80
          y: 282
        type: start
        width: 244
        height: 90

      - id: get_item_data
        data:
          title: Get Item Data
          type: http-request
          method: get
          url: "{{#start.supabase_url#}}/rest/v1/items"
          params: "select=*,sources(*)&id=eq.{{#start.item_id#}}"
          headers: 
            Authorization: "Bearer {{#start.supabase_key#}}"
            apikey: "{{#start.supabase_key#}}"
          body:
            type: none
          desc: "Fetch details from Supabase"
          selected: false
        position:
          x: 380
          y: 282
        type: http-request
        width: 244
        height: 90

      - id: fetch_jina
        data:
          title: Fetch Jina Content
          type: http-request
          method: get
          url: "https://r.jina.ai/{{#get_item_data.body[0].original_url#}}"
          body:
            type: none
          desc: "Get markdown from Jina"
          selected: false
        position:
          x: 680
          y: 282
        type: http-request
        width: 244
        height: 90

      - id: dedup_check
        data:
          title: Dedup Check
          type: code
          code_language: python3
          code: |
            import hashlib
            import requests
            import json
            
            def main(text, current_id, supabase_url, supabase_key):
                if not text:
                    return {"is_duplicate": False, "cleaned_text": ""}
                
                content_hash = hashlib.sha256(text.encode('utf-8')).hexdigest()
                headers = {"apikey": supabase_key, "Authorization": "Bearer " + supabase_key}
                
                # Check for existing hash
                check_url = f"{supabase_url}/rest/v1/items?select=id&content_hash=eq.{content_hash}&id=neq.{current_id}"
                try:
                    resp = requests.get(check_url, headers=headers)
                    duplicates = resp.json()
                    is_dup = len(duplicates) > 0
                except:
                    is_dup = False

                # Update current item hash
                try:
                    patch_url = f"{supabase_url}/rest/v1/items?id=eq.{current_id}"
                    requests.patch(patch_url, headers=headers, json={"content_hash": content_hash})
                except:
                    pass
                    
                return {
                    "is_duplicate": is_dup,
                    "cleaned_text": text
                }
          outputs:
            - is_duplicate
            - cleaned_text
          desc: "Check duplicate hash"
        position:
          x: 980
          y: 282
        type: code
        width: 244
        height: 90

      - id: is_duplicate
        data:
          title: Is Duplicate?
          type: if-else
          conditions:
            - comparison_operator: is_true
              variable_selector: 
                - dedup_check
                - result
                - is_duplicate
          desc: "Branching logic"
        position:
          x: 1280
          y: 282
        type: if-else
        width: 244
        height: 90

      - id: update_skipped
        data:
          title: Set Skipped
          type: http-request
          method: patch
          url: "{{#start.supabase_url#}}/rest/v1/items?id=eq.{{#start.item_id#}}"
          body: 
            type: json
            data: '{"status": "SKIPPED_DUPLICATE"}'
          headers:
            Authorization: "Bearer {{#start.supabase_key#}}"
            apikey: "{{#start.supabase_key#}}"
            Content-Type: "application/json"
        position:
          x: 1580
          y: 100
        type: http-request
        width: 244
        height: 90

      - id: ai_rewrite
        data:
          title: AI Rewrite
          type: llm
          model: 
            provider: openai
            name: gpt-4o-mini
            mode: chat
            completion_params:
              temperature: 0.7
          prompt_template:
            - role: system
              text: "You are a local news journalist. Rewrite the provided text."
            - role: user
              text: "Input Text:\n{{#dedup_check.result.cleaned_text#}}\n\nTask: Rewrite this news for a local portal. Return ONLY a JSON object with keys: 'title', 'content' (HTML format, h2 and p tags only), 'excerpt'."
          context:
            enabled: false
            variable_selector: []
          vision:
            enabled: false
        position:
          x: 1580
          y: 400
        type: llm
        width: 244
        height: 90

      - id: sanity_check
        data:
          title: Sanity Check
          type: code
          code_language: python3
          code: |
            import json
            def main(llm_response):
                try:
                    # Clean potential markdown code blocks
                    clean_resp = llm_response.replace('```json', '').replace('```', '').strip()
                    data = json.loads(clean_resp)
                    
                    content = data.get('content', '')
                    if len(content) < 200:
                        return {"status": "fail", "error": "Content too short"}
                    
                    return {"status": "pass", "title": data['title'], "content": content}
                except Exception as e:
                    return {"status": "fail", "error": str(e)}
          outputs:
            - status
            - title
            - content
            - error
        position:
          x: 1880
          y: 400
        type: code
        width: 244
        height: 90

      - id: sanity_router
        data:
          title: Sanity Passed?
          type: if-else
          conditions:
            - comparison_operator: equal
              value: pass
              variable_selector:
                - sanity_check
                - result
                - status
        position:
          x: 2180
          y: 400
        type: if-else
        width: 244
        height: 90

      - id: publish_wp
        data:
          title: Publish to WP
          type: http-request
          method: post
          url: "{{#get_item_data.body[0].sources.wp_api_endpoint#}}/posts"
          body:
            type: json
            data: |
              {
                "title": "{{#sanity_check.result.title#}}",
                "content": "{{#sanity_check.result.content#}}",
                "status": "publish"
              }
          headers:
            Authorization: "Basic {{#get_item_data.body[0].sources.wp_auth_header#}}"
            Content-Type: "application/json"
        position:
          x: 2480
          y: 300
        type: http-request
        width: 244
        height: 90

      - id: update_success
        data:
          title: Update Success
          type: http-request
          method: patch
          url: "{{#start.supabase_url#}}/rest/v1/items?id=eq.{{#start.item_id#}}"
          body:
            type: json
            data: '{"status": "PUBLISHED", "wp_post_id": "{{#publish_wp.body.id#}}"}'
          headers:
            Authorization: "Bearer {{#start.supabase_key#}}"
            apikey: "{{#start.supabase_key#}}"
            Content-Type: "application/json"
        position:
          x: 2880
          y: 300
        type: http-request
        width: 244
        height: 90
      
      - id: update_failure
        data:
          title: Update Failure
          type: http-request
          method: patch
          url: "{{#start.supabase_url#}}/rest/v1/items?id=eq.{{#start.item_id#}}"
          body:
            type: json
            data: '{"status": "FAILED_SANITY", "error_message": "{{#sanity_check.result.error#}}"}'
          headers:
            Authorization: "Bearer {{#start.supabase_key#}}"
            apikey: "{{#start.supabase_key#}}"
            Content-Type: "application/json"
        position:
          x: 2480
          y: 600
        type: http-request
        width: 244
        height: 90

    edges:
      - id: e1
        source: start
        target: get_item_data
      - id: e2
        source: get_item_data
        target: fetch_jina
      - id: e3
        source: fetch_jina
        target: dedup_check
      - id: e4
        source: dedup_check
        target: is_duplicate
      - id: e5t
        source: is_duplicate
        sourceHandle: true
        target: update_skipped
      - id: e5f
        source: is_duplicate
        sourceHandle: false
        target: ai_rewrite
      - id: e6
        source: ai_rewrite
        target: sanity_check
      - id: e7
        source: sanity_check
        target: sanity_router
      - id: e8t
        source: sanity_router
        sourceHandle: true
        target: publish_wp
      - id: e8f
        source: sanity_router
        sourceHandle: false
        target: update_failure
      - id: e9
        source: publish_wp
        target: update_success
